<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards SRS (v2)</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --primary-color: #4a90e2;
            --primary-text: #ffffff;
            --grey-light: #e0e0e0;
            --grey-dark: #888;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --success: #63b179;
            --warning: #f7b544;
            --danger: #e57373;
        }

        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --grey-light: #2c2c2c;
            --grey-dark: #aaa;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 16px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
        }
        
        #theme-toggle {
            background: none;
            border: 1px solid var(--grey-dark);
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .hidden {
            display: none !important;
        }
        
        #welcome-screen, #app-screen {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        #welcome-screen p {
            margin-bottom: 16px;
        }

        .btn {
            background-color: var(--primary-color);
            color: var(--primary-text);
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 4px;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background-color: var(--grey-light);
            color: var(--text-color);
        }

        #deck-info {
            margin-bottom: 16px;
            color: var(--grey-dark);
        }

        #card-container {
            perspective: 1000px;
            min-height: 200px;
            margin-bottom: 16px;
            cursor: pointer;
        }
        
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 200px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        #card-container.is-flipped .card-inner {
            transform: rotateX(180deg);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border: 1px solid var(--grey-light);
            border-radius: var(--border-radius);
            font-size: 20px;
            white-space: pre-wrap;
        }
        
        .card-front {
            background-color: var(--card-bg);
        }

        .card-back {
            background-color: var(--card-bg);
            transform: rotateX(180deg);
        }

        #answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        #btn-again { background-color: var(--danger); }
        #btn-hard { background-color: var(--warning); }
        #btn-good { background-color: var(--success); }
        #btn-easy { background-color: var(--primary-color); }
        
        .controls {
            margin-top: 24px;
            border-top: 1px solid var(--grey-light);
            padding-top: 16px;
        }

        #file-input {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Flashcards SRS</h1>
            <button id="theme-toggle" title="Changer le th√®me">üåô</button>
        </header>

        <main>
            <div id="welcome-screen">
                <h2>Bienvenue !</h2>
                <p>Chargez un deck depuis un fichier CSV ou commencez avec un de nos decks pr√©charg√©s.</p>
                <button class="btn" id="load-preset-vocab">Charger Vocabulaire Anglais</button>
                <button class="btn" id="load-preset-capitals">Charger Capitales du Monde</button>
                <hr style="margin: 16px 0; border-color: var(--grey-light);">
                <button class="btn btn-secondary" onclick="document.getElementById('file-input').click();">Importer un CSV...</button>
                <input type="file" id="file-input" accept=".csv">
            </div>

            <div id="app-screen" class="hidden">
                <div id="deck-info">
                    <span id="deck-name"></span> | <span id="deck-progress"></span>
                </div>

                <div id="card-container">
                    <div class="card-inner">
                        <div class="card-face card-front" id="card-front"></div>
                        <div class="card-face card-back" id="card-back"></div>
                    </div>
                </div>

                <div id="answer-buttons" class="hidden">
                    <button class="btn" id="btn-again">√Ä revoir (1)</button>
                    <button class="btn" id="btn-hard">Difficile (2)</button>
                    <button class="btn" id="btn-good">Correct (3)</button>
                    <button class="btn" id="btn-easy">Facile (4)</button>
                </div>
                
                <p id="no-cards-message" class="hidden">Bravo ! Aucune carte √† r√©viser pour aujourd'hui.</p>

                <div class="controls">
                    <button class="btn btn-secondary" onclick="document.getElementById('file-input').click();">Charger un autre deck</button>
                    <button class="btn btn-secondary" id="download-progress">T√©l√©charger la progression</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- PRE-LOADED DECKS ---
        const PRESET_DECKS = {
            vocab: `Question,R√©ponse
Apple,"Pomme"
Car,"Voiture"
House,"Maison"
Book,"Livre"
Water,"Eau"
Computer,"Ordinateur"
Tree,"Arbre"
Sun,"Soleil"
Moon,"Lune"
Friend,"Ami(e)"`,
            capitals: `Question,R√©ponse
France,"Paris"
Japon,"Tokyo"
Allemagne,"Berlin"
Canada,"Ottawa"
Australie,"Canberra"
Br√©sil,"Brasilia"
√âgypte,"Le Caire"
Italie,"Rome"
Espagne,"Madrid"
Russie,"Moscou"`
        };

        // --- DOM ELEMENTS ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const appScreen = document.getElementById('app-screen');
        const cardContainer = document.getElementById('card-container');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const answerButtons = document.getElementById('answer-buttons');
        const deckNameEl = document.getElementById('deck-name');
        const deckProgressEl = document.getElementById('deck-progress');
        const fileInput = document.getElementById('file-input');
        const downloadBtn = document.getElementById('download-progress');
        const noCardsMessage = document.getElementById('no-cards-message');
        const themeToggle = document.getElementById('theme-toggle');

        // --- STATE MANAGEMENT ---
        let appState = {
            deckName: null,
            cards: [],
            dueCards: [],
            currentCardIndex: -1
        };

        function saveState() {
            localStorage.setItem('flashcard_app_state', JSON.stringify(appState));
        }

        function loadState() {
            const savedState = localStorage.getItem('flashcard_app_state');
            if (savedState) {
                appState = JSON.parse(savedState);
                return true;
            }
            return false;
        }

        // --- SRS LOGIC (SuperMemo 2 inspired) ---
        function processAnswer(quality) {
            const card = appState.dueCards[appState.currentCardIndex];
            
            if (quality < 2) { // quality 1: Again
                card.intervalle = 1; // See again tomorrow
                card.statut = "apprentissage";
            } else { // quality 2, 3, 4: Hard, Good, Easy
                if (card.statut === 'nouvelle' || card.statut === 'apprentissage') {
                    if (quality === 2) card.intervalle = 1;      // Hard -> 1 day
                    else if (quality === 3) card.intervalle = 3; // Good -> 3 days
                    else card.intervalle = 5;      // Easy -> 5 days
                    card.statut = "r√©vision";
                } else if (card.statut === 'r√©vision') {
                    // SuperMemo 2 algorithm for ease factor
                    card.facteur_facilite = Math.max(1.3, card.facteur_facilite + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
                    card.intervalle = Math.ceil(card.intervalle * card.facteur_facilite);
                }
            }
            
            const reviewDate = new Date();
            reviewDate.setDate(reviewDate.getDate() + card.intervalle);
            card.prochaine_revision = reviewDate.toISOString().split('T')[0];

            saveState();
            nextCard();
        }

        // --- UI & RENDERING ---
        function render() {
            if (!appState.deckName) {
                welcomeScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            } else {
                welcomeScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                
                const today = new Date().toISOString().split('T')[0];
                appState.dueCards = appState.cards.filter(card => card.prochaine_revision <= today);

                deckNameEl.textContent = appState.deckName;
                const totalCards = appState.cards.length;
                const dueCount = appState.dueCards.length;
                deckProgressEl.textContent = `√Ä r√©viser: ${dueCount} / ${totalCards}`;

                if (dueCount > 0) {
                    appState.currentCardIndex = 0;
                    showCard();
                    noCardsMessage.classList.add('hidden');
                } else {
                    cardContainer.classList.add('hidden');
                    answerButtons.classList.add('hidden');
                    noCardsMessage.classList.remove('hidden');
                }
            }
        }
        
        function showCard() {
            const card = appState.dueCards[appState.currentCardIndex];
            cardContainer.classList.remove('hidden', 'is-flipped');
            cardFront.textContent = card.Question;
            cardBack.textContent = card.R√©ponse;
            answerButtons.classList.add('hidden');
        }

        function flipCard() {
            if (appState.dueCards.length > 0) {
                cardContainer.classList.add('is-flipped');
                answerButtons.classList.remove('hidden');
            }
        }

        function nextCard() {
            // This logic is now simpler, as render will rebuild the dueCards list
            render();
        }
        
        // --- CSV HANDLING ---
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const csvText = e.target.result;
                const deckName = file.name.replace(/\.csv$/, '');
                parseCSV(csvText, deckName);
            };
            reader.readAsText(file, 'UTF-8');
            fileInput.value = ""; // Reset input
        }

        function parseCSV(csvText, deckName) {
            try {
                const lines = csvText.trim().split('\n');
                const headers = lines.shift().split(',').map(h => h.trim());
                const qIndex = headers.indexOf('Question');
                const rIndex = headers.indexOf('R√©ponse');
                
                if (qIndex === -1 || rIndex === -1) {
                    alert("Le fichier CSV doit contenir les colonnes 'Question' et 'R√©ponse'.");
                    return;
                }

                const importedCards = lines.map((line, index) => {
                    // Simple CSV parsing, may not handle complex quotes perfectly
                    const values = line.split(',');
                    const now = new Date().toISOString().split('T')[0];
                    return {
                        id_unique: `${deckName}-${index}`,
                        Question: (values[qIndex] || "").trim().replace(/"/g, ''),
                        R√©ponse: (values[rIndex] || "").trim().replace(/"/g, ''),
                        prochaine_revision: now,
                        intervalle: 0,
                        facteur_facilite: 2.5,
                        statut: 'nouvelle'
                    };
                });
                
                appState.deckName = deckName;
                appState.cards = importedCards;
                saveState();
                render();
            } catch (error) {
                alert("Erreur lors de la lecture du fichier CSV. Assurez-vous qu'il est bien format√©.");
                console.error(error);
            }
        }
        
        function downloadProgress() {
            if (!appState.cards || appState.cards.length === 0) return;
            
            const headers = "Question,R√©ponse,prochaine_revision,intervalle,facteur_facilite,statut";
            const rows = appState.cards.map(c => `"${c.Question}","${c.R√©ponse}",${c.prochaine_revision},${c.intervalle},${c.facteur_facilite},${c.statut}`);
            const csvContent = [headers, ...rows].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${appState.deckName}_progress.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- THEME ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô';
            }
        }
        
        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            applySavedTheme();
            if (loadState()) {
                render();
            }
        });

        cardContainer.addEventListener('click', flipCard);
        fileInput.addEventListener('change', handleFileLoad);
        downloadBtn.addEventListener('click', downloadProgress);
        themeToggle.addEventListener('click', toggleTheme);
        
        document.getElementById('load-preset-vocab').addEventListener('click', () => parseCSV(PRESET_DECKS.vocab, 'Vocabulaire Anglais'));
        document.getElementById('load-preset-capitals').addEventListener('click', () => parseCSV(PRESET_DECKS.capitals, 'Capitales du Monde'));

        answerButtons.addEventListener('click', (e) => {
            if(e.target.tagName !== 'BUTTON') return;
            const qualityMap = { 'btn-again': 1, 'btn-hard': 2, 'btn-good': 3, 'btn-easy': 4 };
            processAnswer(qualityMap[e.target.id]);
        });
        
        document.addEventListener('keydown', (e) => {
            if (appState.deckName && appState.dueCards.length > 0) {
                if (e.code === 'Space' && !cardContainer.classList.contains('is-flipped')) {
                    e.preventDefault();
                    flipCard();
                } else if (cardContainer.classList.contains('is-flipped')) {
                    const qualityMap = { 'Digit1': 1, 'Digit2': 2, 'Digit3': 3, 'Digit4': 4 };
                    if (qualityMap[e.code]) {
                        processAnswer(qualityMap[e.code]);
                    }
                }
            }
        });

    </script>
</body>
</html>
